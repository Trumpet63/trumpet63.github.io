{
  "version": 3,
  "sources": ["../../../src/index.js"],
  "sourcesContent": ["let promptDiv = document.getElementById(\"promptDiv\");\r\npromptDiv.addEventListener(\"click\", onClick);\r\nlet canvas;\r\nlet ctx;\r\nfunction onClick() {\r\n    promptDiv.innerText = \"Please Wait...\";\r\n\r\n    canvas = document.createElement(\"canvas\");\r\n    canvas.id = \"mainCanvas\";\r\n    onResize();\r\n    document.body.appendChild(canvas);\r\n\r\n    ctx = canvas.getContext(\"2d\");\r\n\r\n    window.addEventListener(\"resize\", onResize);\r\n\r\n    performTest();\r\n}\r\n\r\nfunction onResize() {\r\n    let w = document.documentElement.clientWidth;\r\n    let h = document.documentElement.clientHeight;\r\n    canvas.width = w;\r\n    canvas.height = h;\r\n}\r\n\r\nlet audioContext;\r\nlet buffer;\r\nlet samples = [];\r\nlet samplesMaxSize = 2000;\r\nlet startTime;\r\nlet previousSample;\r\nlet noChangeCount = 0;\r\nlet channel = new MessageChannel();\r\n\r\n// FireFox has this issue where if you check if the audiocontext time changed\r\n// in a tight loop, it won't ever update it - presumably because we're blocking\r\n// the thread it uses to update it. So a message channel seems like the fastest\r\n// running async thing - faster than setTimeout(0);\r\n// In Chrome I'd prefer to just use a tight loop, but I don't wanna have both\r\n// methods here.\r\nchannel.port1.onmessage = () => {\r\n    let currentSample = audioContext.currentTime;\r\n    if (currentSample !== previousSample) {\r\n        samples.push(currentSample);\r\n        previousSample = currentSample;\r\n    } else {\r\n        noChangeCount++;\r\n    }\r\n\r\n    if (samples.length < samplesMaxSize && performance.now() - startTime < 2000) {\r\n        channel.port2.postMessage(null); // Schedule the next iteration\r\n    } else {\r\n        console.log(\"noChangeCount =\", noChangeCount);\r\n        calculateDeltas();\r\n    }\r\n};\r\n\r\nasync function performTest() {\r\n    audioContext = new (window.AudioContext || window.webkitAudioContext)();\r\n\r\n    // FireFox starts the context suspended\r\n    let waitStartTime;\r\n    if (audioContext.state === \"suspended\") {\r\n        console.log(\"resuming\");\r\n        waitStartTime = performance.now();\r\n        await audioContext.resume();\r\n        console.log(\"Waited \" + (performance.now() - waitStartTime) + \" ms\");\r\n    }\r\n    console.log(audioContext.state);\r\n    \r\n    waitStartTime = performance.now();\r\n    let audioStartTime = audioContext.currentTime;\r\n    // wait until the audio context wakes up, and don't block the main thread\r\n    await new Promise(resolve => {\r\n        function checkTime() {\r\n            if (audioContext.currentTime > audioStartTime) {\r\n                resolve();\r\n            } else {\r\n                requestAnimationFrame(checkTime);\r\n            }\r\n        }\r\n        checkTime();\r\n    });\r\n    console.log(\"Waited \" + (performance.now() - waitStartTime) + \" ms\");\r\n\r\n    startTime = performance.now()\r\n    previousSample = audioContext.currentTime\r\n    channel.port2.postMessage(null); // Start sampling\r\n}\r\n\r\nfunction calculateDeltas() {\r\n    buffer = []\r\n    previousSample = samples[0];\r\n    for (let i = 1; i < samples.length; i++) {\r\n        buffer.push(1000 * (samples[i] - previousSample));\r\n        previousSample = samples[i];\r\n    }\r\n    console.log(\"buffer length\", buffer.length);\r\n\r\n    promptDiv.remove();\r\n    window.requestAnimationFrame(draw);\r\n}\r\n\r\nfunction draw() {\r\n    ctx.fillStyle = \"rgb(50, 50, 50)\";\r\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\r\n\r\n    // get y bounds\r\n    let minDelta = buffer[0];\r\n    let maxDelta = buffer[0];\r\n    for (let i = 1; i < buffer.length; i++) {\r\n        if (buffer[i] > maxDelta) {\r\n            maxDelta = buffer[i];\r\n        }\r\n        if (buffer[i] < minDelta) {\r\n            minDelta = buffer[i];\r\n        }\r\n    }\r\n    let originalMinDelta = minDelta;\r\n    let originalMaxDelta = maxDelta;\r\n    minDelta *= 0.9;\r\n    maxDelta *= 1.1;\r\n\r\n    // draw points\r\n    ctx.lineWidth = 2;\r\n    ctx.strokeStyle = \"rgb(20, 255, 20)\";\r\n    ctx.beginPath();\r\n    for (let i = 0; i < buffer.length; i++) {\r\n        let x = mapLinear(0, i, buffer.length - 1, 0, canvas.width);\r\n        let y = mapLinear(minDelta, buffer[i], maxDelta, canvas.height, 0);\r\n\r\n        if (i == 0) {\r\n            ctx.moveTo(x, y);\r\n        } else {\r\n            ctx.lineTo(x, y);\r\n        }\r\n    }\r\n    ctx.stroke();\r\n\r\n    ctx.fillStyle = \"white\";\r\n    ctx.textAlign = \"right\";\r\n    ctx.textBaseline = \"middle\";\r\n    let fontSize = Math.max(10, canvas.height / 40);\r\n    ctx.font = fontSize + \"px Arial\";\r\n    let y = mapLinear(minDelta, originalMinDelta, maxDelta, canvas.height, 0);\r\n    ctx.fillText(roundToNPlaces(originalMinDelta, 5) + \" ms\", canvas.width - 10, y);\r\n    y = mapLinear(minDelta, originalMaxDelta, maxDelta, canvas.height, 0);\r\n    ctx.fillText(roundToNPlaces(originalMaxDelta, 5) + \" ms\", canvas.width - 10, y);\r\n\r\n    window.requestAnimationFrame(draw);\r\n}\r\n\r\nfunction mapLinear(fromStart, fromValue, fromEnd, toStart, toEnd) {\r\n    fromValue = clampValueToRange(fromValue, Math.min(fromStart, fromEnd), Math.max(fromStart, fromEnd));\r\n    let toValue = Math.abs(fromValue - fromStart) * Math.abs(toEnd - toStart) / Math.abs(fromEnd - fromStart);\r\n    if (toEnd > toStart) {\r\n        toValue = toValue + toStart;\r\n    } else {\r\n        toValue = -toValue + toStart;\r\n    }\r\n    return toValue;\r\n}\r\n\r\nfunction clampValueToRange(value, lowerBound, upperBound) {\r\n    if (value < lowerBound) {\r\n        return lowerBound;\r\n    }\r\n    if (value > upperBound) {\r\n        return upperBound;\r\n    }\r\n    return value;\r\n}\r\n\r\nfunction roundToNPlaces(x, numPlaces) {\r\n    let scale = Math.pow(10, numPlaces);\r\n    return Math.round(x * scale) / scale;\r\n}\r\n"],
  "mappings": "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",
  "names": ["y"]
}
